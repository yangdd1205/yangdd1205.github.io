---
title: TCP/IP 基础
tags:
  - 计算机网络
  - TCP/IP
categories: 计算机网络
date: 2018-04-14 12:33:27
---

> 本篇内容来源于《图解TCP/IP》第二章

上一篇介绍了网络基础知识，这一篇说说 TCP/IP 基础知识。

<!-- more -->

## TCP/IP 与 OSI 协议分层模型

<table>
    <tr>
        <th>OSI 参考模型</th>
        <th colspan="2">TCP/IP 分层模型</th>
    </tr>
    <tr>
        <td>应用层</td>
        <td rowspan="3">应用层<br>DNS、URI、HTML、HTTP<br>TLS/SSL、SMTP、POP、IMAP<br>MIME、TELNET、SSH、FTP<br>SNMP、MIB、SIP、RTP、LDAP</td>
        <td rowspan="3">应用程序</td>
    </tr>
    <tr>
        <td>表示层</td>
    </tr>
    <tr>
        <td>会话层</td>
    </tr>
    <tr>
        <td>传输层</td>
        <td>传输层<br>TCP、UDP、UDP-Lite、SCTP、DCCP</td>
        <td rowspan="2">操作系统</td>
    </tr>
    <tr>
        <td>网络层</td>
        <td>互联网层<br>ARP、IP、ICMP</td>
    </tr>
    <tr>
        <td>数据链路层</td>
        <td>网卡层</td>
        <td rowspan="2">设备驱动程序与网络接口</td>
    </tr>
    <tr>
        <td>物理层</td>
        <td>（硬件）</td>
    </tr>
</table>

### 硬件（物理层）

TCP/IP 的最底层是负责数据传输的硬件。这种硬件就相当于以太网或电话线路等物理层的设备。TCP/IP 是在网络互连的设备之间能够通信的前提下才被提出的协议。

### 网络接口层（数据链路层）

网络接口层利用以太网中的数据链路层进行通信，因此属于接口层。相当于一个“驱动程序”。

### 互联网层（网络层）

互联网层使用 IP 协议，它相当于 OSI 模型中的第 3 层网络层。IP 协议基于 IP 地址转发分包数据。

TCP/IP 分层中的互联网与传输层的功能通常由操作系统提供。尤其是路由器，它必须得实现通过互联网层转发分组数据包的功能。

**IP**

IP 是跨网络传送数据包，使整个互联网都能收到数据的协议。IP 协议使数据能够发送到地球的另一端，这期间它使用 IP 地址作为主机的标识。
IP 还隐含着数据链路层的功能。通过 IP，相互通信的主机之间不论经过怎样的底层数据链路都能实现通信。
**虽然 IP 也是分组交换的一种协议，但是它不具有重发机制**。即使分组数据包未能到达对端主机也不会重发，**属于非可靠性传输协议**。

**ICMP**

IP 数据包在发送途中一旦发生异常导致无法到达对端目标地址时，需要给发送端发送一个发生异常的通常。ICMP 就是为这一功能而制定的。它有时也被用来诊断网络的健康状况。

**ARP**

从分组数据包的 IP 地址中解析出物理地址（MAC 地址）的一种协议。

### 传输层

传输层最主要的功能就是能够让应用程序之间实现通信。计算机内部，通常同一时间运行着多个程序。为此，必须分清是哪些程序与哪些程序在进行通信。识别这些应用程序的是端口号。

**TCP**

TCP 是一种面向有连接的传输层协议。它可以保证两端通信主机之间的通信可达。TCP 能够正确处理在传输过程中丢包、传输顺序乱掉等异常情况。此外，TCP 还能够有效利用宽带，缓解网络拥堵。

然而，为了建立与断开连接，有时它需要至少 7  次的发包收包（3 次握手和 4 次挥手），导致网络流量的浪费。

**UDP**

UDP 有别于 TCP，它是一种面向无连接的传输层协议。UDP 不会关注对端是否真的收到了传送过去的数据，如果需要检查对端是否收到了分组数据包，或者对端是否连接到网络，则需要在应用程序中实现。

UDP 常用于分组数据较少或多播、广播通信以及视频通信等多媒体领域。



### 应用层

TCP/IP 的分层中，将 OSI 参考模型中的会话层、表示层和应用层的功能都集中到了应用程序中实现。这些功能有时由一个单一的程序实现，有时也可能会由多个程序实现。因此，细看 TCP/IP 的应用程序功能会发现，它不仅实现 OSI 模型中应用层的内容，还要实现会话层与表示层的功能。 

## TCP/IP 分层模型与通信模型

### 数据包首部

 ![数据包首部的层次化](http://p0e1o9bcz.bkt.clouddn.com/tcp-ip/data-package.png "数据包首部的层次化")


**包、帧、数据包、段、消息**

包可以说是全能性述语。帧用于表示数据链路层中的包的单位。而数据包是 IP 和 UDP 等网络层以上的分层中包的单位。段则表示 TCP 数据流中的信息。最后，消息是指应用协议中数据的单位。

网络中传输的数据包由两部分组成：一部分是协议所要用到的首部，另一部分是上层传过来的数据。首部的结构由协议的具体规范详细定义。明确标明了协议应该如果读取数据。


### 发送数据包

![TCP/IP 各层对邮件的收发处理](http://p0e1o9bcz.bkt.clouddn.com/tcp-ip/tcp-ip-part-ii-2.png?refresh=1 "TCP/IP 各层对邮件的收发处理")

① 应用层处理

首先，应用程序中会进行编码处理。相当于 OSI 的表示层功能。应用程序在发送邮件的那一刻建立 TCP 连接，从而利用这个 TCP 连接发送数据。它的过程首先是将应用的数据发送给下一层的 TCP，再做实际的转发处理。

② TCP 模块的处理

TCP 根据应用的指示（这种关于连接的指示相当于 OSI 参考模型中的会话层），负者建立连接、发送数据以及断开连接。TCP 将应用层发来的数据顺利发送至对端的可靠传输。

为了实现 TCP 的这一功能，需要在应用层数据的前端附加一个 TCP 首部。TCP 首部中包括源端口号和目标端口号（用以识别发送主机跟接收主机上的应用）、序号（用以发送包中的哪部分是数据）以及校验和（Check Sum，用来检验数据的读取是否正常进行的方法，用以判断数据是否被损坏）。随后将附加了 TCP 首部的包再发送给 IP。


③ IP 模块的处理

IP 将 TCP 传过来的 TCP 首部和 TCP 数据合起来当做自己的数据，并在 TCP 首部的前端在加上自己的 IP 首部。因此，IP 数据包中的 IP 首部后面紧跟着 TCP 首部，然后才是应用程序的首部和数据本身。IP 首部中包含接收端 IP 地址以及发送端 IP 地址。紧随 IP 首部的还有用来判断器后面数据时 TCP 还是 UDP 的信息。

IP 包生成后，参考路由控制表决定接受次 IP 包的路由或主机。随后，IP 包将被发送给连接这些路由器或主机网络接口的驱动程序，以实现真正发送数据。

如果尚不知道接收端的 MAC 地址，可以利用 ARP （Address Resolution Protocol）查找。只要知道了对端的 MAC 地址，就可以将 MAC 地址和 IP 地址交给以太网的驱动程序，以实现数据传输。



④ 网络接口（以太网驱动）的处理

从 IP 传过来的 IP 包，对于以太网驱动来说不过就是数据。给这些数据附加上以太网首部并进行发送处理。以太网首部中包含接收端 MAC 地址、发送端 MAC 地址以及标志以太网类型的以太网数据的协议。根据上述信息产生的以太网数据包将通过物理层传输给接收端。发送处理中的 FCS（Frame Check Sequence）由硬件计算，添加到包的最后。设置 FCS 的目的是为了判断数据包是否由于噪声而被破坏。


### 经过数据链路的包

![分层中包的结构](http://p0e1o9bcz.bkt.clouddn.com/tcp-ip/tcp-ip-part-ii-3.png "分层中包的结构")

包流动时，从前往后依次被附加了以太网包首部、IP 包首部、TCP 包首部（或 UDP 包首部）以及应用自己的包首部和数据。而包的最后则追加了以太网包尾（Ethernet Trailer）。

每个包首部中至少都会包含两个信息：一个是发送端和接收端地址，另一个是上一层的协议类型。

经过每个协议分层时，都必须有识别包发送端和接收端的信息。以太网会用 MAC 地址，IP 会用 MAC 地址，而 TCP/UDP 则会用端口号作为识别两端主机的地址。即使在应用程序中，像电子邮件地址这样的信息也是一种地址标识。这些地址信息都在每个包经由各个分层时，附加到协议对应的包首部里边。

此外，每个分层的包首部中还包含一个识别位，它是用来标识上一层协议的种类信息。例如以太网的包首部中的以太网类型，IP 中的协议类型以及 TCP/UDP 中两个端口号等都起着识别协议类型的作用。就是在应用的首部信息中，有时也会包含一个用来识别其数据类型的标签。

### 数据包接收处理

⑤ 网络接口（以太网驱动）的处理

主机收到以太网包以后，首先从以太网的包首部找到 MAC 地址判断是否为发给自己的包。如果不是则丢弃数据（很多 NIC 产品可以设置为即使不是发给自己的包也不丢弃数据，这可以用于监控网络流量）。

而如果接收到了恰好是发给自己的包，就查找以太网包首部中的类型区域从而确定以太网协议所传送过来的数据类型。在这个例子中数据类型显示是 IP 包，因此再将数据传给处理 IP 的子程序，如果这时不是 IP 而是其他诸如 ARP 的协议，就把数据传给 ARP 处理。总之，如果以太网包首部的类型域包含了一个无法识别的协议类型，则丢弃数据。


⑥ IP 模块的处理

IP 模块收到 IP 包首部及后面的数据部分以后，也做类似的处理。如果判断得出首部中的 IP 地址与自己的 IP 地址匹配，则可接收数据并从中查找上一层协议。如果上一层是 TCP 就将 IP 包首部之后部分传给 TCP 处理；如果是 UDP 则传给 UPD 处理。对于有路由器的情况下，接收端地址往往不是自己的地址，此时，需要借助路由控制表，在得知应该送达的主机或路由器以后再转发数据。

⑦ TCP 模块的处理

在 TCP 模块中，首先会计算下校验和，判断数据是否被破坏。然后检查是否在按照序号接收数据。最后检查端口号，确定具体的应用程序。

数据接收完毕后，接收端则发送一个“确定回执”给发送端。如果这个回执信息未能达到发送端，那么发送端会认为接收端没有接收到数据而一直反复发送。

数据被完整地接收以后，会传给由端口号识别的应用程序。

⑧ 应用程序的处理

接收端应用程序会直接接收发送端发送的数据。通过解析数据可以获知邮件的收件人地址是乙的地址。如果主机 B 上没有乙的邮件信箱，那么主机 B 返回给发送端一个“无此收件地址”的报错信息。

