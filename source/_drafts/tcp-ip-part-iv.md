---
title: IP 协议
tags:
  - 计算机网络
  - TCP/IP
categories: 计算机网络

---

> 本篇内容来源于《图解TCP/IP》第四章

IP 作为整个 TCP/IP 中至关重要的协议，主要负责将数据包发送给最终的目标计算机。


## IP 即网际协议

TCP/IP 的心脏是互联网层。这一层主要由 IP（Internet Protocol）和 ICMP（Internet Control Message Protocol）两个协议组成。

### IP 相当于 OSI 参考模型的第 3 层

IP（IPv4、IPv6）相当于 OSI 参考模型中的第 3 层——网络层。

网络层的主要作用是“实现终端节点之间的通信”。这种终端节点之间的通信也叫“点对点（end-to-end）通信”。

数据链路层的主要作用是在互连同一种数据链路的节点之间进行包传递。而一旦跨越多种数据链路，就需要借助网络层。网络层可以跨越不同的数据链路，即使是在不同的数据链路上也能实现两节点之间的数据包传输。


### 网络层与数据链路层的关系

数据链路层提供直连两个设备之间的通信功能。与之相比，作为网路层的 IP 则负责在没有直连的两个网络之间进行通信传输。

举例说明，上海到成都，先买到上海到武汉，在武汉换乘到重庆，在重庆换乘到成都。每张票相当于链路层，整个行程（上海到成都）相当于网路层。

## IP 基础知识

### IP 地址属于网路层地址

IP 地址用于在“连接到网络中所有主机中识别出进行通信的目标地址”。

### 路由控制

路由控制（Routing）是指将分组数据发送到最终目标地址的功能。即使网络非常复杂，也可以通过路由控制确定到达目标地址的通路。一旦这个路由控制运行出现异常，分组数据极有可能“迷失”，无法到达目标地址。因此，一个数据包之所以能够成功地到达最终目标地址，全靠路由控制。

Hop 译为中文叫“跳”。它是指网络中的一个区间。IP 包正是在网络中一个跳间被转发。因此 IP 路由也叫做多跳路由。在每一个区间内决定着包在下一跳被转发的路径。

为了将数据包发给目标主机，所有主机都维护着一张路由控制表（Routing Table）。该表记录 IP 数据在下一步应该发给哪一个路由器。IP 包将根据这个路由表在各个数据链路上传输。

### 数据链路的抽象化

IP 是实现多个数据链路之间通信的协议。数据链路根据种类的不同各有特点。对这些不同数据链路的相异特性进行抽象化也是 IP 的重要作用之一。

不同数据链路有个最大的区别，就是它们各自的最大传输单位（MTU：Maximun Transmission Unit）不同。 IP 的上一层可能会要求传送比这些 MTU 更多字节的数据，因此必须在线路上传送比包长还要小的 MTU。

为了解决这个问题，IP 进行分片处理（IP Fragmentation）。顾名思义，所谓分片处理是指，将较大的 IP 包分层多个较小的 IP 包。分片的包到了对端目标地址后再被组合起来传给上一层。即从 IP 的上次层看，它完全可以忽略数据包在途中的各个数据链路上的 MTU，只需要安装源地址发送的长度接收数据包。IP 就是以这种方式抽象化了数据链路层，使得从上层更不容易看到底层网络结构的细节。

### IP 属于面向无连接型

IP 面向无连接。即在发包之前，不需要建立与对端目标地址之间的连接。上层如果遇到需要发送给 IP 的数据，该数据会立即压缩成 IP 包发送出去。

IP 要采用面向无连接的原因？一是为了简化，二是为了提速。

IP 提供尽力服务（Best Effort），意指“为了把数据包发送到最终目标地址，尽最大努力”。然而，它并不做“最终收到与否的验证”。消息的可靠性则由 TCP 提供。



## IP 地址的基础知识

### IP 地址的定义

IP 地址（IPv4 地址）由 32 位正整数来表示。以每 8 位为一组，分成 4 组，每组以“.”隔开，再将每组数转换为十进制数。


### IP 地址由网络和主机两部分表示组成

IP 地址由“网络标识（网络地址）”和“主机标识（主机地址）”两部分组成。

网络标识在数据链路的每个段配置不同的值，必须保证相互连接的每个段的地址不相重复。而相同段内相连的主机必须有相同的网络地址。IP 地址的“主机标识”则不允许在同一网段内重复出现。

IP 包被转发到途中某个路由器时，正是利用目标 IP 地址的网络标识进行路由的。因此即使不看主机标识，只要一见到网络标识就能判断出是否为该网段内的主机。

![IP 地址的网络标识和主机标识]()

### IP 地址的分类

IP 地址分为四个级别，分别为 A 类、B 类、C 类、D 类。它根据 IP 地址中从第 1 位到第 4 位的比特对其网络标识和主机标识进行区分。

**A 类地址**
A 类 IP 地址是首位以 “0” 开头的地址。从第 1 位到第 8 位是它的网络标识。用十进制表示的话，0.0.0.0 ~ 127.0.0.0 是 A 类的网络地址。A 类地址的后 24 位相当于主机标识。因此，一个网段内可容纳的主机地址上限为 16，777，214 个。

**B 类地址**
B 类 IP 地址是前两位为 “10” 的地址。从第 1 位到第 16 位是它的网络标识。用十进制表示的话，128.0.0.1 ~ 191.255.0.0 是 B 类的网络地址。B 类地址的后 16 位相当于主机标识。因此，一个网段内可容纳的主机地址上限为 65，534 个。

**C 类地址**
C 类 IP 地址是前三位为 “110” 的地址。从第 1 位到第 24 位是它的网络标识。用十进制表示的话，192.168.0.0 ~ 239.255.255.0 是 C 类的网络地址。C 类地址的后 8 位相当于主机标识。因此，一个网段内可容纳的主机地址上线为 254 个。

**D 类地址**
D 类 IP 地址是前四位为 “1100” 的地址。从第 1 位到第 32 位是它的网络标识。用十进制表示的话，224.0.0.0 ~ 239.255.255.255 是 D 类的网络地址。D 类地址没有主机标识，常被用于多播。

### 关于分配 IP 主机地址的注意事项

用比特位表示主机地址时，不可全部为 0 或全部为 1。因为全部为只有 0 在表示对应的网络地址或 IP 地址不可获知的情况下使用。而全部为 1 的主机地址通常作为广播地址。

### 广播地址

广播地址用于在同一个链路中相互连接的主机之间发送数据包。将IP地址中的主机地址部分全部设置为1，就变成了广播地址。

**两种广播**

广播分为本地广播和直播广播两种。

在本网络内的广播叫做本地广播。例如网络地址为 192.168.0.0/24 的情况下，广播地址是 192.168.0.255。因为这个广播地址的 IP 包会被路由器屏蔽，所以不会到达 192.168.0.0/24 以外的其他链路上。

在不同网络之间的广播剧叫做直接广播。例如网络地址为 192.168.0.0/24 的主机向 192.168.1.255/24 的目标地址发送 IP 包。收到这个包的路由器，将数据转发给 192.168.1.0/24，从而使得所有 192.168.1.1 ~ 192.168.1.254 的主机都能收到这个包。

### IP 多播

**同时发送提高效率**

多播用于将包发给特定组内的所有主机。由于其直接使用 IP 协议，因此也不存在可靠传输。


**IP 多播与地址**

多播使用 D 类地址。因此，如果从首位开始到第 4 位是 “1110”，就可以认为是多播地址。而剩下的 28 位可以成为多播的组编号。

![]( "多播地址")


### 子网掩码

网络标识相同的计算机必须同属于同一链路。例如，架构 B 类 IP 网络时，理论上一个链路内允许 6 万 5 千多台计算机连接。然而，在实际网络架构当中，一般不会有同一个链路上连接 6 万 5 千多台计算机的情况。因此，这种网络结构实际不存在的。

**子网与子网掩码**

现在，一个 IP 地址的网络标识和主机标识已不再受限于该地址的类别，而是由一个叫做 “子网掩码” 的识别码通过子网网络地址细分出来比 A 类、B 类、C 类更小粒度的网络。这种方式实际上就是将原来 A 类、B 类、C 类等分类中的 **主机地址部分用作子网地址，可以将原网络分为多个物理网络的一种机制。**

子网掩码用二进制方式表示的话，也是一个 32 位的数字。它对应 IP 地址网络标识部分的位全部为 “1”，对应 IP 地址主机标识的部分则全部为 “0”。子网掩码必须是 IP 地址的首位开始连续的 “1”。

![]( "子网掩码可以灵活指定网络标识的长度")

### CIDR 与 VLSM

由于向各种组织分配 IP 地址都以 A 类、B 类、C 类等分类为单位进行，导致 IP 地址严重缺乏，无法满足需求。

于是，人们开始放弃 IP 地址的分类，采用任意长度分割 IP 地址的网络标识和主机标识。这种方式叫做 CIDR（无类别域间路由，Classless Inter-Domain Routing)。由于 BGP（Border Gateway Protocol，边界网关协议）对应了 CIDR，所以不受 IP 地址分配的限制自由分配。


### 全局地址与私有地址

起初，互联网中的任何一台主机或者路由器必须配有一个唯一的 IP 地址。导致 IP 地址不够用，于是就出现了一种新技术。它不要求每一台主机或路由器分配一个固定的 IP 地址，而是在必要的时候只为相应数量的设备分配唯一的 IP 地址。

尤其对于那些没有连接互联网的独立网络中的主机，只要保证在这个网络内地址唯一，可以不用考虑互联网即可配置相应的 IP 地址。不过，即使让每个独立的网络各自随意地设置 IP 地址，也可能会有问题。于是又出现了私有网络的 IP 地址。
它的地址范围如下所示：
![]( "私有网络的 IP 地址")


包含在这个范围内的 IP 地址都属于私有 IP，而在此之外的 IP 地址（A 类 ~ C 类 范围中除去 0/8、127/8）称为全局 IP（也叫公网 IP）。

私有 IP 最早没有计划连接互联网，而只用于互联网之外的独立网络。然而，当一种能够互换私有 IP 与全局 IP 的 NAT 技术诞生以后，配有私有地址的主机与配有全局地址的互联网主机实现了通信。

现在很多的公司内部正采用在每个终端设置私有 IP，而在路由器（宽带路由器）或在必要的服务器上设置全局 IP 地址的方法。而如果配有私有 IP 的地址主机连网时，则通过 NAT 进行通信。

![]( "全局 IP 与私有 IP")


### 全局地址有谁决定

在世界范文内，全局 IP 由 ICANN（Internet Corporation for Assigned Names and Numbers，互联网名称与数字地址分配机构）


## 路由控制

发送数据包时所使用的地址是网络层的地址，即 IP 地址。然而仅仅有 IP 地址还不足以实现将数据包发送到对端目标地址，在数据发送过程中还需要类似于“指明路由器或主机”的信息，以便真正发往目标地址。保存这种信息的就是路由控制表（Routing Table）。

路由控制表的形成方式有两种：一种是管理员手动设置，另一种是路由器与其他路由器相互交换信息时自动刷新。前者也叫静态路由控制，而后者叫做动态路由控制。

### IP 地址与路由控制

IP 地址的网络地址部分用于进行路由控制。


![]( "路由控制表与 IP 包发送")


路控制表中记录着网络地址与下一步应该发送至路由器的地址（在 Windows 或 Unix 上表示路由表的方法分别为 `netstat -r` 或者 `nststat -rn\`）。在发送 IP 包时，首先要确定 IP 包首部中的目标地址，再从路由控制表中找到与该地址具有相同网络地址的记录，根据该记录将 IP 包转发给相应的下一个路由器。如果路由控制表中存在多条相同网络地址的记录，就选择一个最为吻合的网络地址。所谓最为吻合是相同位数最多的意思（也叫做最长匹配）。

**默认路由**

默认路由是指路由表中任何一个地址都能与之匹配的记录。

默认路由一般标记为 0.0.0.0/0 或者 default（表示子网掩码时，IP 地址为 0.0.0.0，子网掩码也是 0.0.0.0）。这里的 0.0.0.0/0 并不是指 IP 地址是 0.0.0.0。由于后面是 “/0”，所以并没有标识 IP 地址（0.0.0.0 的 IP 地址应述为 0.0.0.0/32）。它只是为了避免人们误以为 0.0.0.0 是 IP 地址。有时默认路由也被标记为 default，但是在计算机内部和路由协议的发送过程中还是以 0.0.0.0/0 进行处理。

**主机路由**
"IP 地址/32" 也被称为主机路由（Host Route）。例如，192.168.153.15/32（表示子网掩码时，若 IP 地址为 192.168.153.15，其对应的子网掩码为 255.255.255.255）就是一一种主机路由。它的意思是整个 IP 地址的所有位都将参与路由。进行主机路由，意味着要基于主机上网卡配置的 IP 地址本身，而不是基于该地址的网络地址部分进行路由。

**环回地址**

环回地址是在同一台计算机上的程序之间进行网络通信时所使用的一个默认地址。计算机使用一个特殊的 IP 地址 127.0.0.1 作为环回地址。与该地址具有相同意义的是一个叫做 localhost 的主机名。使用这个 IP 或主机名时，数据包不会流向网络。

### 路由控制表的聚合

利用网络地址的比特分布可以有效地进行分层配置。对内即使有多个子网掩码，对外呈现出的也是同一个网络地址。这样可以更好地构建网络，通过路由信息的聚合可以减少路由表的条目。


## IP 分割处理与再构成处理

## IPv6


## IPv4 首部


## IPv6 首部

## 


