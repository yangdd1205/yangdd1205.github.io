---
title: 程序中的异常处理
categories: 编程经验
tags:
 - 异常处理
---

> 本文来源于极客时间[陈皓](https://coolshell.cn/)的专栏[《左耳听风》](https://time.geekbang.org/column/intro/48)

是返回错状态，还是用异常捕获的方式处理，不仅仅要结合场景来判断，还要从程序设计的角度思考。
<!-- more -->


## 错误返回码 VS 异常捕获

我个人觉得错误可以被分成三个大类。

* **资源的错误**。当我们的代码去请求一些资源时导致的错误，比如打开一个没有权限的文件，写文件时出现的写错误，发送文件到网络端发现网络故障的错误，等等。**这一类错误属于程序运行环境的问题。对于这类错误，有的我们可以处理，有的我们则无法处理。比如，内存耗尽、栈溢出或是一些程序运行时关键性资源不能满足时，我们只能停止运行，甚至退出整个程序**。

* **程序的错误**。比如：空指针、非法参数等。**这类是我们自己程序的错误，我们要记录下来，写入日志，最好触发监控系统报警**。

* **用户的错误**。比如：Bad Request、Bad Format 等这类由用户的不合法输入带来的错误。**这类错误基本上是在用户的 API 层上出现的问题**。比如，解析一个 XML 或 JSON 文件，或是用户输入的字段不合法之类的。**对于这类问题，我们需要向用户端报错，让用户自己处理修正他们的输入或操作。然后，我们正常执行，但是我们需要做统计，统计相应的错误率，这样有利于我们改善软件或者侦测是否有恶意的用户请求**。

所以，是不是我们可以这样来在逻辑上分类：

* 对于我们并不期望会发生的事，我们可以使用异常捕获。
* 对于我们觉得可能会发生的事，使用返回码。




## 异步编程世界里的错误处理

然而，这些知识和经验仅在同步编程世界中适用。因为在异步编程世界里，被调用的函数是放到了另外一个线程里面运行的。这将导致：

* **无法使用返回码**。因为函数在被异步运行中，所谓的返回只是把处理权交给下一条指令，而不是把函数运行完的结果返回。**所以，函数返回的语义完全变了，返回码也没有用了**。

* **无法使用抛异常的方式**。因为除了上述的函数立马返回的原因之外，抛出的异常也在另外一个线程中，不同线程的栈是完全不一样的。所以主线程的 catch 完全看不到另外一个线程中的异常。

对此，在异步编程的世界里，我们也会有好几种处理错误的方法，最常见的就是 callback 方法。



## 错误处理的最佳实践

* **统一分类的错误字典**。无论你使用错误码还是异常捕捉，都需要认真并统一地做好错误的分类。最好是在同一个地方定义相关的错误。比如，HTTP 的 4XX 表示客户端有问题，5XX 表示服务端有问题。也就是说，你要建立一个错误字典。

* **同类错误的定义最好可以扩展的**。这一点非常重要，而对于这一点，通过面向对象的继承或是像 Go 语言那样的接口多态可以很好地做到。这样可以方便地重用已有的代码。

* **定义错误的严重程度**。比如，Fatal 表示重大错误，Error 表示资源或需求得不到满足，Warning 表示并不一定是一个错误但还是需要引起注意，Info 表示不是错误只是一个信息，Debug 表示这是给内部开发人员用于调试程序的。

* **错误日志的输出最好使用错误码，而不是错误信息**。打印错误日志的时候，除了要用统一的格式，最好不要用错误信息，而是使用相应的错误码，错误码不一定是数字，也可以是一个能从错误字典里面找到的一个唯一的可以让人读懂的关键字。这样，会非常有利于日志分析软件自动化监控，而不是要从错误信息中做语义分析，比如：HTTP 的日志中就会有 HTTP 的返回码，如：404。但我更推荐像使用 PageNotFound 这样的标识，这样人和机器都很容易处理。

* **忽略错误最好有日志**。不然会给维护带来很大的麻烦。

* **对于同一个地方不停的报错，最好不用都打到日志里**。不然这样就会导致其它日志被淹没了，也会导致日志文件太大，最好的实践是，打出一个错误以及出现的次数。

* **不要用错误处理逻辑来处理业务逻辑**。也就是说，不要使用异常捕捉这样的方式来处理业务逻辑，而是应该用条件判断。如果一个逻辑控制可以用 if-else 清楚地表达，非常不建议使用异常方式处理。异常捕获是用来处理不期望发生的事的，而错误码则是用来处理可能会发生的事的。

* **对于同类的错误处理，用一样的模式**。比如，对于 null 对象的错误，要么都用返回 null，加上条件检查的模式，要么都用抛 NullPointerException 的方式处理。不要混用，这样有助于代码规范。

* **尽可能在错误发生的地方处理错误**。因为这样会让调用者变得更简单。

* **向上尽可能地返回原始的错误**。如果一定要把错误返回到更高层去处理，那么，应该返回原始的错误，而不是重新发明一个错误。

* **处理错误时，总是要清理已分配的资源**。这点非常关键，使用 RAll 技术，或是 try-catch-finally，或者是 Go 的 defer 都可以容易地做到。

* **不推荐在循环体里处理错误**。这里说的更多的情况是对于 try-catch 这种情况，对于绝大多数的情况你不需要这样做。最好把整个循环体外放在 try 语句块内，而在外面做 catch。

* **不要把大量的代码都放在一个 try 语句块内**。一个 try 语句块内的语句应该是完成一个简单单一的事情。

* **为你的错误定义提供清楚的文档以及每种错误的代码示例**。如果你是在 RESTful API 方面的，使用 Swagger 会帮你很容易搞定这个事。

* **对于异步的方式，推荐使用 Promise 模式处理错误**。对于这一点，JavaScript 中有很好的实践。

* **对于分布式的系统，推荐使用 APM 相关的软件**。尤其是使用 Zipkin 这样的服务调用跟踪的分析来关联错误。

